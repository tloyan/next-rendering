# Composition Patterns

### ğŸ’¡ Comment composer notre application de RCC et RSC

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Avec `Next` et les `React Server Components`, il faut toujours se poser la question. Dois-je faire une `RCC` (Client) ou un `RSC` (Serveur) et surtout comment organiser son application pour avoir des `RCC` et `RSC` qui sâ€™imbriquent correctement.

**Faire 100% de RCC ?**

- On perd lâ€™avantage du `SSR`, de la rÃ©duction du `bundle client` etc â€¦

**Faire 100% de RSC ?**

- Impossible, car lâ€™application nâ€™aurait aucune interactivitÃ©.

![rcc-rsc-usage.png](/course/rcc-rsc-usage.png)

```tsx
![rcc-rsc-usage.png](/course/rcc-rsc-usage.png)
```

ğŸ“‘ Le lien vers la doc https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#when-to-use-server-and-client-components

VoilÃ  Ã  quoi pourrait ressembler un arbre de composants pour notre segment de route :

- Des `RSC` qui contiennent des `RCC`.
- Des `RCC` qui contiennent des `RSC`.

![rcc-rsc-tree](/course/rcc-rsc-tree.png)

```tsx
![rcc-rsc-tree.png](/course/rcc-rsc-tree.png)
```

Mais il y a certaines conditions Ã  respecter.

- Les `RSC` peuvent contenir des `RCC` sans contraintes (par `import` ou `props`).
- Les `RCC` peuvent contenir des `RSC` (via `props` : `children` ou autres `props`).

Exemple :

- Il est interdit dâ€™importer des `RCC` dans des `RCC`

```tsx
//app/client-component.tsx
'use client'

// You cannot import a Server Component into a Client Component.
import ServerComponent from './Server-Component'

export default function ClientComponent({
  children,
}: {
  children: React.ReactNode
}) {
  const [count, setCount] = useState(0)

  return (
    <>
      <button onClick={() => setCount(count + 1)}>{count}</button>
      <ServerComponent />
    </>
  )
}
```

- Solution de contournement (`props children`)

```tsx
//app/client-component.tsx
'use client'

import {useState} from 'react'

export default function ClientComponent({
  children,
}: {
  children: React.ReactNode
}) {
  const [count, setCount] = useState(0)

  return (
    <>
      <button onClick={() => setCount(count + 1)}>{count}</button>
      {children}
    </>
  )
}
```

```tsx
import ClientComponent from './client-component'
import ServerComponent from './server-component'

// Pages in Next.js are Server Components by default
export default function Page() {
  return (
    <ClientComponent>
      <ServerComponent />
    </ClientComponent>
  )
}
```

![rcc-rsc-tree-prop.png](/course/rcc-rsc-tree-prop.png)

```tsx
![rcc-rsc-tree-prop.png](/course/rcc-rsc-tree-prop.png)
```

ğŸ“‘ Le lien vers la doc [https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components](https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components)

Pour les exercices, nous utiliserons un composant qui dÃ©tecte le type du composant (en se basant sur la prÃ©sence de `window`) et affiche une couleur

```tsx
const actualType = detectActualType()
//server ou client
export function detectActualType() {
  return typeof window === 'undefined'
    ? ComponentTypeEnum.SERVER
    : ComponentTypeEnum.CLIENT
}
```

- Rouge â€”> Client
- Bleu â€”> Serveur

![component-tree.png](/course/component-tree.png)

```tsx
![component-tree.png](/course/component-tree.png)
```

## Exercice

Dans cet exercice, nous allons essayer plusieurs combinaisons possibles

- Client â†’ Server (`children`)
- Server â†’ Client (`children`)
- Server contenant un Client (`import`)
- Client contenant un Serveur (`import`)

Pour nous aider, il existe des composants :

- `server.tsx` : Le composant `<Server>` contenant `â€˜use serverâ€™`
- `client.tsx` : Le composant `<Client>` contenant `â€˜use clientâ€™`
- `clientWithServer.tsx` : Composant client qui importe un `<Server>`
- `servertWithClient.tsx` : Composant serveur qui importe un `<Client>`

Fichiers quâ€™il nous suffira dâ€™importer et utiliser dans `page.tsx`

<aside>
ğŸ’¡ *PS : `<ClientWithServer />` risque de poser problÃ¨me ce qui est normal un `RCC` ne peut pas importer un `RSC`*

</aside>

Fichiers

- `exercise/composition/page.tsx`

## Bonus

### 1. ğŸš€ RCIC (React Contextual Isomorphic Component)

Les `RCIC` ne sont pas nommÃ©s explicitement comme cela dans la documentation de `Next.js`. Jâ€™ai dÃ©fini ce terme explicitement pour dÃ©crire un type particulier de composants `React` dans `Next.js`.

- **React Component** : Ce sont des composants React classiques.
- **Isomorphic** : Ils peuvent s'exÃ©cuter cÃ´tÃ© `Client` ou cÃ´tÃ© `Server`, selon le contexte.
  - **Sans interactivitÃ© client** : Pas d'utilisation de `hooks` ou d'Ã©vÃ©nements spÃ©cifiques au client.
  - **Sans opÃ©rations serveur** : Pas d'opÃ©rations d'entrÃ©e/sortie (IO) ou d'accÃ¨s aux ressources serveur directes.
- **Contextual** : Leur type (client ou serveur) dÃ©pend du contexte dans lequel ils sont inclus (importÃ©s).
  - Lorsqu'ils sont inclus (importÃ©s) dans un composant client, ils adoptent le comportement du client.
  - Lorsqu'ils sont inclus (importÃ©s) dans un composant serveur, ils adoptent le comportement du serveur.
  - Lorsqu'ils sont passÃ©s en tant que `children` Ã  un composant (client ou serveur), ils sont serveur par dÃ©faut.

Dans notre arbre de composant, Ã  partir du moment oÃ¹ un composant devient explicitement client `â€˜use clientâ€™` les `RCIC` enfant importÃ©s seront des `clients`. Ce qui alourdit le bundle et peut rendre lâ€™`hydration` plus longue. VoilÃ  pourquoi il est recommandÃ© :

<aside>
ğŸ’¡ Descendre les `RCC` le plus bas possible dans lâ€™arbre de composant

</aside>

Exemple de composition identique . La seule diffÃ©rence est le parent :

![compo-iso-tree.png](/course/compo-iso-tree.png)

```tsx
![compo-iso-tree.png](/course/compo-iso-tree.png)
```

- ğŸ¶ Dans cet exercice, nous avons un `RSC` (`server.tsx` `<Server>`) mais qui ne contient pas de code spÃ©cifique au client (`FS` par exemple) ou de code client (`Hook`, `Localstorage` par exemple)

**Il est donc candidat pour Ãªtre un `RCIC`**

- ğŸ¶ Transforme le en `RCIC` (`server.tsx`)
  - **â›ï¸ Supprime la directive** `use server`
  - **ğŸ¤– Change son type pour lâ€™afficher correctement :**
    **ğŸ¤–**`componentType={ComponentTypeEnum.ISOMORPHIC}`

```tsx
//server.tsx
'use server'
import React from 'react'
import {CardComponentType} from '@/components/card-component-type'
import {ComponentTypeEnum, detectActualType} from '@/lib/helper'

export default async function Server({children}: {children?: React.ReactNode}) {
  const actualType = detectActualType()
  return (
    <CardComponentType
      componentType={ComponentTypeEnum.SERVER}
      actualType={actualType}
    >
      {children}
    </CardComponentType>
  )
}
```

- ğŸ¶ Utilise le dans `page.tsx`

```tsx
<ClientWithServer />
```

Fichiers

- `exercise/composition/server.tsx`
- `exercise/composition/page.tsx`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components](https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=04%20Rendering%20AvancÃ©e&entry.533578441=07%20composition-patterns).
